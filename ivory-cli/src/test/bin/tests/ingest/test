#!/bin/sh -eux

DIR=$(dirname $0)
. "${DIR}/../../setup.sh"

$IVORY create-repository -z "Australia/Sydney" "${REPOSITORY}"
$IVORY import-dictionary -p "${INPUT}/dictionary.psv"

### Ingest a factset directory with several namespaces
$IVORY ingest -i "${INPUT}/facts-1"
$IVORY cat-facts "${REPOSITORY}/factsets/00000000/*/*/*/*/*" | sort > "${TARGET}/all-facts.psv"
diff_test "${DIR}/expected/all-facts.psv" "${TARGET}/all-facts.psv"
# Check that errors are captured (in the right place)
$IVORY cat-errors "${REPOSITORY}/errors/*/*" > "${TARGET}/error-facts.psv"
diff_test "${DIR}/expected/error-facts.psv" "${TARGET}/error-facts.psv"

### Ingest a factset directory with a single namespace
$IVORY ingest -i "${INPUT}/facts-2" -n HALIBUT
$IVORY cat-facts "${REPOSITORY}/factsets/00000001/*/*/*/*/*" | sort > "${TARGET}/halibut-facts.psv"
diff_test "${DIR}/expected/halibut-facts.psv" "${TARGET}/halibut-facts.psv"

### Ingest from S3
if [ ! -z "${AWS_TEST_BUCKET:-}" ]
then
  S3_INGEST_1="s3://${AWS_TEST_BUCKET}/tests/cli/$(random)"
  aws s3 sync "${INPUT}/facts-3" ${S3_INGEST_1} --sse
  $IVORY ingest -i ${S3_INGEST_1}
  $IVORY cat-facts "${REPOSITORY}/factsets/00000002/*/*/*/*/*" | sort > "${TARGET}/all-facts-s3.psv"
  diff_test "${DIR}/expected/all-s3-facts.psv" "${TARGET}/all-facts-s3.psv"

  S3_INGEST_2="s3://${AWS_TEST_BUCKET}/tests/cli/$(random)"
  aws s3 sync "${INPUT}/facts-4" ${S3_INGEST_2} --sse
  $IVORY ingest -i ${S3_INGEST_2} -n HALIBUT
  $IVORY cat-facts "${REPOSITORY}/factsets/00000003/*/*/*/*/*" | sort > "${TARGET}/halibut-facts-s3.psv"
  diff_test "${DIR}/expected/halibut-s3-facts.psv" "${TARGET}/halibut-facts-s3.psv"
else
  echo "Skipping S3 Ingest test. AWS_TEST_BUCKET is not set."
fi


### Ingest with an invalid namespace - should fail
$IVORY ingest -r "${REPOSITORY}" -i "${INPUT}/facts-2" -n invalid | grep "Unknown namespaces"
