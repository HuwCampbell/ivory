#!/bin/sh -eux

DIR=$(dirname $0)
. "${DIR}/../../setup.sh"

$IVORY create-repository "${REPOSITORY}"
$IVORY import-dictionary -p "${INPUT}/dictionary.psv"
$IVORY ingest -z "Australia/Sydney" -i "${INPUT}/facts"

snapshot() {
  $IVORY snapshot -d ${1}
  $IVORY cat-facts "${REPOSITORY}/snapshots/0000000${2}" | sort > "${TARGET}/snapshot${2}.psv"
  diff_test "${DIR}/expected/snapshot${2}.psv" "${TARGET}/snapshot${2}.psv"
}

snapshot 2014-05-02 0
snapshot 2014-07-02 1

$IVORY snapshot -o "dense:psv=${TARGET}/pivot" --date 2014-07-02 --sample-rate 1
diff_test "${DIR}/expected/pivot.psv" "${TARGET}/pivot/part-r-00000"
diff_test "${DIR}/expected/dictionary.psv" "${TARGET}/pivot/.dictionary"
# It's a little hard to check the profile, but at least make sure it contains an entry for each feature
cat "${TARGET}/pivot/.profile"
[ $(wc -l "${TARGET}/pivot/.profile" | awk '{print $1}') = $(wc -l "${TARGET}/pivot/.dictionary" | awk '{print $1}') ]

$IVORY chord -o "dense:psv=${TARGET}/chord" --entities "${INPUT}/chord.psv" --sample-rate 1
diff_test "${DIR}/expected/chord.psv" "${TARGET}/chord/part-r-00000"
