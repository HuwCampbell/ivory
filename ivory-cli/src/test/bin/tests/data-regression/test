#!/bin/sh -eux

DIR=$(dirname $0)
. "${DIR}/../../setup.sh"
DICT_NAME="dict_regression"

### V0 ###

V0="ivory_run ${IVORY_V0}"
$V0 create-repository -p "${REPOSITORY}"
$V0 import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary.psv" -n "${DICT_NAME}"
$V0 ingest-bulk -r "${REPOSITORY}" -z "Australia/Sydney" -i "${INPUT}/facts" -d "${DICT_NAME}"

### V1 - Dictionary thrift format ###

V1="ivory_run $IVORY_V1"
$V1 import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary.psv"

### LATEST ###

# TODO Instead of piping the stdout output, we should write the content directly to a file
# https://github.com/ambiata/ivory/issues/22

### DICTIONARY ###

# Need to remove extra blank line
$IVORY cat-dictionary -r "${REPOSITORY}" | grep -v "^$" | sort > "${TARGET}/dictionary.psv"
diff_test "${DIR}/expected/dictionary.psv" "${TARGET}/dictionary.psv"

### SNAPSHOT ###

$IVORY snapshot -r "${REPOSITORY}" -f "pivot=${TARGET}/snap-pivot"
$IVORY cat-facts "${REPOSITORY}/snapshots/00000000" | sort > "${TARGET}/snapshot.psv"
diff_test "${DIR}/expected/snapshot.psv" "${TARGET}/snapshot.psv"
diff_test "${DIR}/expected/snap-pivot.psv" "${TARGET}/snap-pivot/out-r-00000"
COUNT_FACTS_OUT=$($IVORY count-facts "${REPOSITORY}/snapshots/00000000")
[ $(wc -l ${DIR}/expected/snapshot.psv | awk '{print $1}') = $COUNT_FACTS_OUT ]

### CHORD ###

$IVORY chord -r "${REPOSITORY}" -o "${TARGET}" -t "/tmp/chord-$(random)" -c "${INPUT}/chord.psv" -f "pivot=${TARGET}/chord-pivot"
$IVORY cat-facts "${TARGET}/thrift" | sort > "${TARGET}/chord.psv"
diff_test "${DIR}/expected/chord.psv" "${TARGET}/chord.psv"
diff_test "${DIR}/expected/chord-pivot.psv" "${TARGET}/chord-pivot/out-r-00000"

### COMMIT ###

[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "0" ]

# Force something to bump the commit, doesn't really matter what
$IVORY import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary2.psv"
[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "1" ]
diff_test "${DIR}/expected/metadata/commits/00000000" "${REPOSITORY}/metadata/commits/00000000"
