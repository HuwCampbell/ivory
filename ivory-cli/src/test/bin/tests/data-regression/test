#!/bin/sh -eux

DIR=$(dirname $0)
. "${DIR}/../../setup.sh"
DICT_NAME="dict_regression"

### V0 ###

V0="ivory_run ${IVORY_V0}"
$V0 create-repository "${REPOSITORY}"
$V0 import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary.psv" -n "${DICT_NAME}"
$V0 ingest-bulk -r "${REPOSITORY}" -z "Australia/Sydney" -i "${INPUT}/facts" -d "${DICT_NAME}"

### V1 - Dictionary thrift format ###

V1="ivory_run $IVORY_V1"
$V1 import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary.psv"

### LATEST ###

# TODO Instead of piping the stdout output, we should write the content directly to a file
# https://github.com/ambiata/ivory/issues/22

### DICTIONARY ###

# Need to remove the first line which comes out as a warning for the optional codec
# + any extra blank line
$IVORY cat-dictionary | tail -n +2 | grep -v "^$" | sort > "${TARGET}/dictionary.psv"
diff_test "${DIR}/expected/dictionary.psv" "${TARGET}/dictionary.psv"

diff_test_mr() {
  EXPECTED=$1
  MR_OUT=$2
  cat ${MR_OUT}/part-* | sort > ${MR_OUT}/all.psv
  diff_test "${EXPECTED}" "${MR_OUT}/all.psv"
}

### SNAPSHOT ###

$IVORY snapshot -o "dense:psv=${TARGET}/snap-dense" -o "sparse:psv=${TARGET}/snap-sparse"
$IVORY cat-facts "${REPOSITORY}/snapshots/00000000" | sort > "${TARGET}/snapshot.psv"
diff_test "${DIR}/expected/snapshot.psv" "${TARGET}/snapshot.psv"
diff_test_mr "${DIR}/expected/snap-dense.psv" "${TARGET}/snap-dense"
diff_test_mr "${DIR}/expected/snap-sparse.psv" "${TARGET}/snap-sparse"
COUNT_FACTS_OUT=$($IVORY count-facts "${REPOSITORY}/snapshots/00000000")
[ $(wc -l ${DIR}/expected/snapshot.psv | awk '{print $1}') = $COUNT_FACTS_OUT ]

### CHORD ###

$IVORY chord -c "${INPUT}/chord.psv" -o "dense:psv=${TARGET}/chord-dense" -o "sparse:psv=${TARGET}/chord-sparse"
cat ${TARGET}/chord-dense/part-* | sort > "${TARGET}/chord-dense/all.psv"
diff_test "${DIR}/expected/chord-dense.psv" "${TARGET}/chord-dense/all.psv"
diff_test_mr "${DIR}/expected/chord-dense.psv" "${TARGET}/chord-dense"
diff_test_mr "${DIR}/expected/chord-sparse.psv" "${TARGET}/chord-sparse"
### COMMIT ###

[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "0" ]

# Force something to bump the commit, doesn't really matter what
$IVORY import-dictionary -p "${INPUT}/dictionary2.psv"
[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "1" ]
diff_test "${DIR}/expected/metadata/commits/00000000" "${REPOSITORY}/metadata/commits/00000000"
