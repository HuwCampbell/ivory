#!/bin/sh -eux

DIR=$(dirname $0)
. "${DIR}/../../setup.sh"
DICT_NAME="dict_regression"

### V0 ###

V0="ivory_run ${IVORY_V0}"
$V0 create-repository -p "${REPOSITORY}"
$V0 import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary.psv" -n "${DICT_NAME}"
$V0 ingest-bulk -r "${REPOSITORY}" -z "Australia/Sydney" -i "${INPUT}/facts" -d "${DICT_NAME}"

### V1 - Dictionary thrift format ###

V1="ivory_run $IVORY_V1"
$V1 import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary.psv"

### LATEST ###

# TODO Instead of piping the stdout output, we should write the content directly to a file
# https://github.com/ambiata/ivory/issues/22

### DICTIONARY ###

# Need to remove extra blank line
$IVORY cat-dictionary -r "${REPOSITORY}" | grep -v "^$" | sort > "${TARGET}/dictionary.psv"
diff_test "${DIR}/expected/dictionary.psv" "${TARGET}/dictionary.psv"

### SNAPSHOT ###

$IVORY extract-snapshot -r "${REPOSITORY}"
$IVORY cat-facts "${REPOSITORY}/snapshots/00000000" | sort > "${TARGET}/snapshot.psv"
diff_test "${DIR}/expected/snapshot.psv" "${TARGET}/snapshot.psv"
COUNT_FACTS_OUT=$($IVORY count-facts "${REPOSITORY}/snapshots/00000000")
[ $(wc -l ${DIR}/expected/snapshot.psv | awk '{print $1}') = $COUNT_FACTS_OUT ]

### CHORD ###

$IVORY extract-chord -r "${REPOSITORY}" -o "${TARGET}" -t "/tmp/chord-$(random)" -c "${INPUT}/chord.psv"
$IVORY cat-facts "${TARGET}/thrift" | sort > "${TARGET}/chord.psv"
diff_test "${DIR}/expected/chord.psv" "${TARGET}/chord.psv"

### Additional imports to test metadata creation in new versions ###

[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "0" ]

# The first commit is for the load migrate of the dictionary.
# The second is the ingest.
$IVORY ingest -r "${REPOSITORY}" -z "Australia/Sydney" -i "${INPUT}/facts"
[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "2" ]

$IVORY import-dictionary -r "${REPOSITORY}" -p "${INPUT}/dictionary2.psv"
[ $(ls "${REPOSITORY}/metadata/commits" | wc -l | awk '{print $1}') = "3" ]

diff_test "${DIR}/expected/metadata/commits/00000000" "${TARGET}/metadata/commits/00000000"
diff_test "${DIR}/expected/metadata/commits/00000001" "${TARGET}/metadata/commits/00000001"
diff_test "${DIR}/expected/metadata/dictionaries/00000000/data" "${TARGET}/metadata/dictionaries/00000000/data"
diff_test "${DIR}/expected/metadata/dictionaries/00000001/data" "${TARGET}/metadata/dictionaries/00000001/data"
diff_test "${DIR}/expected/metadata/dictionaries/00000002/data" "${TARGET}/metadata/dictionaries/00000002/data"
diff_test "${DIR}/expected/metadata/dictionaries/dict_regression/dictionary.psv" "${TARGET}/metadata/dictionaries/dict_regression/dictionary.psv"
diff_test "${DIR}/expected/metadata/stores/00000" "${TARGET}/metadata/stores/00000"
diff_test "${DIR}/expected/metadata/stores/00001" "${TARGET}/metadata/stores/00001"
